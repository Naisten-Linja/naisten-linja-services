#!/usr/bin/env bash

# Load environment variables from .env file if it exists
if [ -f .env ]; then
  set -a
  while IFS= read -r line || [ -n "$line" ]; do
    # Skip comments and empty lines
    [[ "$line" =~ ^[[:space:]]*# ]] && continue
    [[ -z "${line// }" ]] && continue
    # Export the variable
    export "$line" 2>/dev/null || true
  done < .env
  set +a
fi

# Check if required variables are set
if [ -z "$DB_PORT" ]; then
  echo "Error: DB_PORT is not set. Please create a .env file from .env.example and set DB_PORT."
  exit 1
fi

container_name='naisten_linja_db'

if [[ $(docker ps -a -f "name=${container_name}" --format '{{.Names}}') == $container_name ]]; then
    echo "Starting container ${container_name}."
    docker start ${container_name}
else
    echo "Container $container_name not found. Creating a new one."
    docker run --name ${container_name} -e POSTGRES_USER=${DB_USERNAME} -e POSTGRES_PASSWORD=${DB_PASSWORD} -e POSTGRES_DB=${DB_NAME} -v "/$(pwd)/db-data:/var/lib/postgresql/data" -p ${DB_PORT}:5432 -d postgres:11.9
fi

tries=0
max_tries=5

until (nc -vzw 2 localhost $DB_PORT) || (($tries == 5))
do
    sleep 2
    ((tries+=1))
done

if (($tries == $max_tries)); then
    exit 1
fi
